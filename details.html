<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hall Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-image: linear-gradient(to right, #14555F, #0B1940);
            background-attachment: fixed;
        }
        .details-card { 
            background-color: #f8fafc; 
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto 1fr;
            gap: 8px;
        }
        .slot {
            width: 100%;
            height: 2.5rem;
            border-radius: 0.25rem;
            cursor: default;
            transition: all 0.2s ease-in-out;
        }
        .slot-available-weekday { 
            background-color: #bbf7d0;
            border: 1px solid #16a34a; 
        }
        .slot-available-weekend { 
            background-color: #dcfce7;
            border: 1px solid #86efac; 
        }
        .slot-booked { 
            background-color: #fee2e2; 
            border: 1px solid #fca5a5; 
        }
        .slot-pending { 
            background-color: #fef9c3; 
            border: 1px solid #fde047; 
        }
        .slot-past { 
            background-color: #e5e7eb; 
            border: 1px solid #d1d5db; 
        }
        .date-header-day { 
            color: #ef4444; /* Red for Sundays */
        }
        .date-header-saturday {
            color: #f97316; /* Orange for Saturdays */
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [x-cloak] { 
            display: none !important; 
        }

        @keyframes slide-right {
          0%, 100% {
            transform: translateX(-15px);
            opacity: 0.8;
          }
          50% {
            transform: translateX(15px);
            opacity: 1;
          }
        }
        .scroll-indicator-arrow {
          animation: slide-right 2.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="nav-placeholder"></div>

    <main class="flex-grow p-6" x-data="hallDetails()">
        <div class="container mx-auto max-w-7xl bg-white p-6 rounded-lg shadow-xl">
            <template x-if="isLoading">
                <p class="text-center text-gray-500 py-10">Loading hall details...</p>
            </template>

            <div x-show="!isLoading && errorMessage" class="text-center text-red-500 py-10" x-text="errorMessage"></div>

            <template x-if="!isLoading && !errorMessage && currentHall.id">
                <div x-cloak>
                    <!-- Hall Details Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="details-card border border-gray-200 rounded-lg p-4">
                            <h3 class="text-xl font-bold text-center text-indigo-900 mb-4">Hall Details</h3>
                            <div class="space-y-2 text-gray-700">
                                <p class="font-bold text-lg" x-text="currentHall.name"></p>
                                <p>Capacity: <span class="font-semibold" x-text="currentHall.capacity"></span></p>
                                <p>Floor: <span class="font-semibold capitalize" x-text="currentHall.floor.toLowerCase()"></span></p>
                                <p>Zone: <span class="font-semibold capitalize" x-text="currentHall.zone.toLowerCase()"></span></p>
                            </div>
                        </div>
                        <div class="details-card border border-gray-200 rounded-lg p-4">
                            <h3 class="text-xl font-bold text-center text-indigo-900 mb-4">Features</h3>
                            <div class="space-y-2 text-gray-700">
                                <template x-for="feature in currentHall.features" :key="feature">
                                    <p><i class="fas fa-check-circle text-blue-500 mr-2"></i><span class="capitalize" x-text="feature.replace('_', ' ').toLowerCase()"></span></p>
                                </template>
                                <template x-if="!currentHall.features || currentHall.features.length === 0">
                                    <p>No special features listed.</p>
                                </template>
                            </div>
                        </div>
                        <div class="details-card border border-gray-200 rounded-lg p-4">
                             <h3 class="text-xl font-bold text-center text-indigo-900 mb-4">Ownership</h3>
                            <div class="space-y-2 text-gray-700">
                                <p>Belongs To: <span class="font-semibold capitalize" x-text="currentHall.belongs_to.toLowerCase()"></span></p>
                                <p x-show="currentHall.schoolName">School: <span class="font-semibold" x-text="currentHall.schoolName"></span></p>
                                <p x-show="currentHall.departmentName">Department: <span class="font-semibold" x-text="currentHall.departmentName"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Calendar Section -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-center text-indigo-900 mb-4">Booking Availability</h3>
                        
                        <!-- Calendar Navigation -->
                        <div class="flex justify-between items-center mb-4">
                            <button @click="navigate('prev')" class="p-2 rounded-full hover:bg-gray-200 transition">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 class="text-lg font-bold" x-text="`${calendar.monthName} ${calendar.year}`"></h4>
                            <button @click="navigate('next')" class="p-2 rounded-full hover:bg-gray-200 transition">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <!-- Calendar Grid Wrapper for Scroll Indicator -->
                        <div class="relative">
                            <!-- Scroll Indicator Overlay -->
                            <div x-show="showScrollIndicator" x-transition:leave="transition ease-in duration-500" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                                 class="absolute inset-0 bg-gray-900 bg-opacity-60 flex flex-col items-center justify-center text-white z-10 rounded-lg pointer-events-none">
                                <i class="fas fa-arrows-alt-h text-5xl mb-4 scroll-indicator-arrow"></i>
                                <p class="text-lg font-semibold">Scroll sideways for more dates</p>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="calendar-grid" 
                                 @wheel.prevent="$refs.headerScroller.scrollLeft += $event.deltaY; $refs.bodyScroller.scrollLeft += $event.deltaY; hideScrollIndicator()" 
                                 @touchstart="hideScrollIndicator">
                                <!-- Top-left empty cell -->
                                <div></div>

                                <!-- Date Headers (Horizontally scrollable) -->
                                <div class="overflow-x-auto hide-scrollbar"
                                     x-ref="headerScroller"
                                     @scroll="$refs.bodyScroller.scrollLeft = $refs.headerScroller.scrollLeft; hideScrollIndicator()">
                                    <div :style="`display: grid; grid-template-columns: repeat(${calendar.days.length}, minmax(50px, 1fr)); gap: 4px;`" class="pb-2">
                                        <template x-for="day in calendar.days" :key="`${calendar.year}-${calendar.month}-${day.date}`">
                                            <div class="text-center">
                                                <div class="text-sm font-semibold" 
                                                     :class="{
                                                         'date-header-day': day.dayName === 'Sun',
                                                         'date-header-saturday': day.dayName === 'Sat'
                                                     }" 
                                                     x-text="day.date"></div>
                                                <div class="text-xs text-gray-500" 
                                                     :class="{
                                                         'date-header-day': day.dayName === 'Sun',
                                                         'date-header-saturday': day.dayName === 'Sat'
                                                     }" 
                                                     x-text="day.dayName"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Time Labels (Vertically aligned) -->
                                <div class="grid grid-cols-1 gap-1 pr-4">
                                    <template x-for="time in timeSlots" :key="time">
                                        <div class="text-sm text-right text-gray-600 h-10 flex items-center justify-end" x-text="formatTimeForDisplay(time)"></div>
                                    </template>
                                </div>

                                <!-- Calendar Body (Scrolls with header) -->
                                <div class="grid grid-cols-1 overflow-x-auto"
                                     x-ref="bodyScroller"
                                     @scroll="$refs.headerScroller.scrollLeft = $refs.bodyScroller.scrollLeft; hideScrollIndicator()">
                                    <template x-for="time in timeSlots" :key="time">
                                        <div :style="`display: grid; grid-template-columns: repeat(${calendar.days.length}, minmax(50px, 1fr)); gap: 4px;`">
                                            <template x-for="day in calendar.days" :key="`${calendar.year}-${calendar.month}-${day.date}-${time}`">
                                                <div class="slot" :class="getSlotClasses(day, time)" :title="getSlotTooltip(day, time)"></div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>


                        <!-- Updated Legend -->
                        <div class="flex flex-wrap justify-center items-center space-x-4 mt-4 text-sm">
                            <div class="flex items-center"><span class="h-4 w-4 rounded-sm mr-2 slot-available-weekday"></span> Available (Weekday)</div>
                            <div class="flex items-center"><span class="h-4 w-4 rounded-sm mr-2 slot-available-weekend"></span> Available (Weekend)</div>
                            <div class="flex items-center"><span class="h-4 w-4 rounded-sm mr-2 slot-pending"></span> Pending</div>
                            <div class="flex items-center"><span class="h-4 w-4 rounded-sm mr-2 slot-booked"></span> Booked</div>
                            <div class="flex items-center"><span class="h-4 w-4 rounded-sm mr-2 slot-past"></span> Past</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center items-center mt-8 space-x-4">
                        <a :href="userRole === 'admin' ? '../manageHall.html' : 'bookBrowse.html'" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-md hover:bg-gray-300 transition-colors">Back to List</a>
                        <a x-show="userRole !== 'admin'" :href="`book.html?hall_id=${currentHall.id}`" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors">Proceed to Book</a>
                    </div>
                </div>
            </template>
        </div>
    </main>
    <div id="footer-placeholder"></div>

    <script>
    function hallDetails() {
        return {
            isLoading: true,
            errorMessage: '',
            currentHall: {},
            userRole: '',
            currentDate: new Date(),
            calendar: { year: 0, month: 0, monthName: '', days: [] },
            processedBookings: {},
            timeSlots: ['09:30', '10:30', '11:30', '12:30', '13:30', '14:30', '15:30', '16:30'],
            showScrollIndicator: true,
            scrollIndicatorTimeout: null,

            async init() {
                const urlParams = new URLSearchParams(window.location.search);
                const hallId = urlParams.get('hall_id');
                this.userRole = urlParams.get('role');
                
                if (!hallId) {
                    this.errorMessage = 'No Hall ID provided in the URL.';
                    this.isLoading = false;
                    return;
                }

                try {
                    await this.fetchHallData(hallId);
                    await this.fetchPendingBookings(hallId);
                    await this.fetchScheduleData(hallId);
                    this.generateCalendar();

                    // Set timeout to hide the scroll indicator
                    this.scrollIndicatorTimeout = setTimeout(() => {
                        this.showScrollIndicator = false;
                    }, 5000); // Hide after 5 seconds

                } catch (error) {
                    this.errorMessage = `Failed to load hall details: ${error.message}`;
                } finally {
                    this.isLoading = false;
                }
            },

            hideScrollIndicator() {
                if (this.showScrollIndicator) {
                    clearTimeout(this.scrollIndicatorTimeout); // Clear the auto-hide timeout
                    this.showScrollIndicator = false;
                }
            },

            async fetchWithAuth(url, options = {}) {
                const headers = getAuthHeaders();
                if (!headers) { logout(); throw new Error('User not authenticated'); }
                const config = { ...options, headers: {...headers, ...options.headers} };
                const response = await fetch(url, config);
                if (response.status === 401) { logout(); throw new Error('Authentication failed'); }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred' }));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                return response.json();
            },

            async fetchHallData(hallId) {
                const url = AppConfig.apiBaseUrl + AppConfig.endpoints.getHallById + hallId;
                const data = await this.fetchWithAuth(url);
                this.currentHall = {
                    id: data.unique_id,
                    name: data.name,
                    capacity: data.capacity,
                    floor: data.floor,
                    zone: data.zone,
                    features: data.features || [],
                    belongs_to: data.belongs_to || 'N/A',
                    schoolName: data.school?.school_name,
                    departmentName: data.department?.department_name
                };
            },

            async fetchPendingBookings(hallId) {
                const url = AppConfig.apiBaseUrl + AppConfig.endpoints.pendingBook + hallId;
                const pendingData = await this.fetchWithAuth(url);
                if (pendingData && pendingData.data) {
                    pendingData.data.forEach(booking => {
                        let currentTime = new Date(booking.start_time);
                        const endDate = new Date(booking.end_time);
                        while (currentTime < endDate) {
                            const dateKey = currentTime.toISOString().split('T')[0];
                            const hours = String(currentTime.getUTCHours()).padStart(2, '0');
                            const minutes = String(currentTime.getUTCMinutes()).padStart(2, '0');
                            const timeKey = `${hours}:${minutes}`;

                            if (this.timeSlots.includes(timeKey)) {
                                if (!this.processedBookings[dateKey]) this.processedBookings[dateKey] = {};
                                this.processedBookings[dateKey][timeKey] = 'pending';
                            }
                            
                            currentTime.setUTCHours(currentTime.getUTCHours() + 1);
                        }
                    });
                }
            },

            async fetchScheduleData(hallId) {
                const url = AppConfig.apiBaseUrl + AppConfig.endpoints.getHallSchedule + hallId;
                const scheduleData = await this.fetchWithAuth(url);
                if (scheduleData && scheduleData.data) {
                    scheduleData.data.forEach(booking => {
                        let currentTime = new Date(booking.start_time);
                        const endDate = new Date(booking.end_time);
                        while (currentTime < endDate) {
                            const dateKey = currentTime.toISOString().split('T')[0];
                            const hours = String(currentTime.getUTCHours()).padStart(2, '0');
                            const minutes = String(currentTime.getUTCMinutes()).padStart(2, '0');
                            const timeKey = `${hours}:${minutes}`;

                            if (this.timeSlots.includes(timeKey)) {
                                if (!this.processedBookings[dateKey]) this.processedBookings[dateKey] = {};
                                this.processedBookings[dateKey][timeKey] = 'booked';
                            }
                            
                            currentTime.setUTCHours(currentTime.getUTCHours() + 1);
                        }
                    });
                }
            },

            generateCalendar() {
                this.calendar.year = this.currentDate.getFullYear();
                this.calendar.month = this.currentDate.getMonth();
                this.calendar.monthName = this.currentDate.toLocaleString('default', { month: 'long' });
                const daysInMonth = new Date(this.calendar.year, this.calendar.month + 1, 0).getDate();
                this.calendar.days = [];
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateObj = new Date(Date.UTC(this.calendar.year, this.calendar.month, i));
                    this.calendar.days.push({
                        date: i,
                        fullDate: dateObj.toISOString().split('T')[0],
                        dayName: dateObj.toLocaleString('en-US', { weekday: 'short', timeZone: 'UTC' }),
                        dayIndex: dateObj.getUTCDay(),
                        isWeekend: dateObj.getUTCDay() === 0 || dateObj.getUTCDay() === 6
                    });
                }
            },

            navigate(direction) {
                if (direction === 'next') {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                } else {
                    const today = new Date();
                    today.setDate(1);
                    today.setHours(0, 0, 0, 0);
                    if (this.currentDate > today) {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    }
                }
                this.generateCalendar();
            },

            getSlotStatus(day, time) {
                const now = new Date();
                const [hour, minute] = time.split(':');
                const slotDateTime = new Date(day.fullDate);
                slotDateTime.setUTCHours(hour, minute, 0, 0);

                if (slotDateTime < now) {
                    return 'past';
                }
                
                const bookingStatus = this.processedBookings[day.fullDate]?.[time];
                if (bookingStatus) {
                    return bookingStatus;
                }
                
                return day.isWeekend ? 'available-weekend' : 'available-weekday';
            },

            getSlotClasses(day, time) {
                const status = this.getSlotStatus(day, time);
                return {
                    'slot-past': status === 'past',
                    'slot-booked': status === 'booked',
                    'slot-pending': status === 'pending',
                    'slot-available-weekday': status === 'available-weekday',
                    'slot-available-weekend': status === 'available-weekend',
                };
            },

            getSlotTooltip(day, time) {
                const status = this.getSlotStatus(day, time);
                const localDate = new Date(`${day.fullDate}T00:00:00Z`).toLocaleDateString(undefined, { timeZone: 'UTC' });
                const displayTime = this.formatTimeForDisplay(time);
                
                switch(status) {
                    case 'available-weekday': return `Available (Weekday): ${localDate} at ${displayTime}`;
                    case 'available-weekend': return `Available (Weekend): ${localDate} at ${displayTime}`;
                    case 'booked': return `Booked: ${localDate} at ${displayTime}`;
                    case 'pending': return `Pending: ${localDate} at ${displayTime}`;
                    case 'past': return `Past Slot: ${localDate} at ${displayTime}`;
                    default: return `${localDate} at ${displayTime}`;
                }
            },
            
            formatTimeForDisplay(time) {
                const [hour, minute] = time.split(':');
                const h = parseInt(hour);
                const suffix = h >= 12 ? 'pm' : 'am';
                let displayHour = h % 12;
                if (displayHour === 0) { 
                    displayHour = 12;
                }
                return `${String(displayHour)}:${minute} ${suffix}`;
            }
        }
    }
</script>
    <script src="layout.js"></script>
</body>
</html>
